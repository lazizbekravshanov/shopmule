generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id             String    @id @default(cuid())
  name           String
  contactName    String?
  phone          String?
  email          String?
  billingAddress String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  Invoice        Invoice[]
  Vehicle        Vehicle[]
}

model EmployeeProfile {
  id                  String                @id @default(cuid())
  name                String
  role                Role
  payRate             Float
  status              String                @default("active")
  userId              String                @unique
  pin                 String? // 4-digit PIN for quick clock-in
  photoUrl            String?
  phoneNumber         String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  User                User                  @relation(fields: [userId], references: [id])
  TimeEntry           TimeEntry[]
  WorkOrderAssignment WorkOrderAssignment[]
  WorkOrderLabor      WorkOrderLabor[]
  PunchRecord         PunchRecord[]
  Timesheet           Timesheet[]
  GeofenceAssignment  GeofenceAssignment[]
  ShopAssignment      ShopAssignment[]
}

model Invoice {
  id                   String        @id @default(cuid())
  workOrderId          String        @unique
  customerId           String
  subtotalParts        Float
  subtotalLabor        Float
  tax                  Float
  discount             Float         @default(0)
  total                Float
  status               PaymentStatus @default(UNPAID)
  portalTokenHash      String?
  portalTokenExpiresAt DateTime?
  portalViewedAt       DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  Customer             Customer      @relation(fields: [customerId], references: [id])
  WorkOrder            WorkOrder     @relation(fields: [workOrderId], references: [id])
  Payment              Payment[]
}

model Part {
  id            String          @id @default(cuid())
  sku           String          @unique
  name          String
  category      String?
  cost          Float
  price         Float
  stock         Int             @default(0)
  reorderPoint  Int             @default(0)
  vendorId      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  Vendor        Vendor?         @relation(fields: [vendorId], references: [id])
  WorkOrderPart WorkOrderPart[]
}

model Payment {
  id                    String   @id @default(cuid())
  invoiceId             String
  method                String
  amount                Float
  receivedAt            DateTime @default(now())
  stripeChargeId        String?
  stripePaymentIntentId String?  @unique
  stripeStatus          String?
  Invoice               Invoice  @relation(fields: [invoiceId], references: [id])
}

model TimeEntry {
  id              String          @id @default(cuid())
  employeeId      String
  clockIn         DateTime
  clockOut        DateTime?
  jobId           String?
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
}

// ==========================================
// TIME TRACKING & ATTENDANCE MODELS
// ==========================================

model Shop {
  id              String           @id @default(cuid())
  name            String
  address         String?
  city            String?
  state           String?
  zipCode         String?
  latitude        Float?
  longitude       Float?
  timezone        String           @default("America/New_York")
  geofenceRadius  Int              @default(150) // meters
  geofenceEnabled Boolean          @default(true)
  photoOnPunch    Boolean          @default(false)
  qrCodeEnabled   Boolean          @default(false)
  pinEnabled      Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  Geofence        Geofence[]
  PunchRecord     PunchRecord[]
  ShopAssignment  ShopAssignment[]
}

model Geofence {
  id                 String               @id @default(cuid())
  shopId             String
  name               String
  latitude           Float
  longitude          Float
  radiusMeters       Int                  @default(150)
  isRequired         Boolean              @default(true)
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Shop               Shop                 @relation(fields: [shopId], references: [id], onDelete: Cascade)
  PunchRecord        PunchRecord[]
  GeofenceAssignment GeofenceAssignment[]

  @@index([shopId])
}

model GeofenceAssignment {
  id              String          @id @default(cuid())
  geofenceId      String
  employeeId      String
  assignedAt      DateTime        @default(now())
  Geofence        Geofence        @relation(fields: [geofenceId], references: [id], onDelete: Cascade)
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([geofenceId, employeeId])
}

model ShopAssignment {
  id              String          @id @default(cuid())
  shopId          String
  employeeId      String
  isPrimary       Boolean         @default(false)
  assignedAt      DateTime        @default(now())
  Shop            Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([shopId, employeeId])
}

model PunchRecord {
  id                   String          @id @default(cuid())
  employeeId           String
  type                 PunchType
  timestamp            DateTime        @default(now())
  latitude             Float?
  longitude            Float?
  accuracy             Float? // GPS accuracy in meters
  photoUrl             String?
  geofenceId           String?
  shopId               String?
  isWithinGeofence     Boolean?
  distanceFromGeofence Float? // meters from geofence center
  workOrderId          String?
  punchMethod          PunchMethod     @default(APP)
  deviceInfo           String?
  ipAddress            String?
  isOfflinePunch       Boolean         @default(false)
  offlineSyncedAt      DateTime?
  notes                String?
  createdAt            DateTime        @default(now())
  EmployeeProfile      EmployeeProfile @relation(fields: [employeeId], references: [id])
  Geofence             Geofence?       @relation(fields: [geofenceId], references: [id])
  Shop                 Shop?           @relation(fields: [shopId], references: [id])
  WorkOrder            WorkOrder?      @relation(fields: [workOrderId], references: [id])

  @@index([employeeId])
  @@index([timestamp])
  @@index([shopId])
}

model Timesheet {
  id                 String          @id @default(cuid())
  employeeId         String
  periodStart        DateTime
  periodEnd          DateTime
  totalRegularHours  Float           @default(0)
  totalOvertimeHours Float           @default(0)
  totalBreakHours    Float           @default(0)
  totalPaidHours     Float           @default(0)
  status             TimesheetStatus @default(PENDING)
  submittedAt        DateTime?
  approvedBy         String?
  approvedAt         DateTime?
  rejectedReason     String?
  notes              String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  EmployeeProfile    EmployeeProfile @relation(fields: [employeeId], references: [id])
  ApprovedByUser     User?           @relation("TimesheetApprover", fields: [approvedBy], references: [id])

  @@unique([employeeId, periodStart, periodEnd])
  @@index([employeeId])
  @@index([status])
}

model AttendanceNotification {
  id          String           @id @default(cuid())
  recipientId String
  type        NotificationType
  title       String
  message     String
  data        Json?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())
  Recipient   User             @relation(fields: [recipientId], references: [id])

  @@index([recipientId])
  @@index([isRead])
}

model AttendanceAuditLog {
  id            String   @id @default(cuid())
  actorId       String
  action        String
  entityType    String
  entityId      String
  changesBefore Json?
  changesAfter  Json?
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime @default(now())
  Actor         User     @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([timestamp])
}

model OvertimeRule {
  id                   String   @id @default(cuid())
  name                 String
  dailyThresholdHours  Float    @default(8)
  weeklyThresholdHours Float    @default(40)
  overtimeMultiplier   Float    @default(1.5)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model BreakRule {
  id                   String   @id @default(cuid())
  name                 String
  autoDeductMinutes    Int      @default(0)
  afterHoursWorked     Float    @default(6)
  reminderAfterMinutes Int?
  isPaid               Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

enum PunchType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
}

enum PunchMethod {
  APP
  PIN
  QR_CODE
  FACIAL
  MANUAL
  KIOSK
}

enum TimesheetStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

enum NotificationType {
  LATE_ARRIVAL
  EARLY_DEPARTURE
  MISSED_SHIFT
  FORGOT_CLOCK_OUT
  OVERTIME_APPROACHING
  OVERTIME_EXCEEDED
  GEOFENCE_VIOLATION
  SHIFT_REMINDER
  BREAK_REMINDER
  TIMESHEET_PENDING
  TIMESHEET_APPROVED
  TIMESHEET_REJECTED
}

model User {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  passwordHash           String
  role                   Role
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  EmployeeProfile        EmployeeProfile?
  AttendanceNotification AttendanceNotification[]
  AttendanceAuditLog     AttendanceAuditLog[]
  TimesheetApprovals     Timesheet[]              @relation("TimesheetApprover")
}

model Vehicle {
  id           String      @id @default(cuid())
  vin          String      @unique
  unitNumber   String?
  make         String
  model        String
  year         Int?
  mileage      Int?
  licensePlate String?
  customerId   String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  Customer     Customer    @relation(fields: [customerId], references: [id])
  WorkOrder    WorkOrder[]
}

model Vendor {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Part      Part[]
}

model WorkOrder {
  id                  String                @id @default(cuid())
  vehicleId           String
  status              WorkOrderStatus       @default(DIAGNOSED)
  description         String
  checklist           String?
  notes               String?
  laborHours          Float                 @default(0)
  partsTotal          Float                 @default(0)
  laborRate           Float                 @default(125)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Invoice             Invoice?
  Vehicle             Vehicle               @relation(fields: [vehicleId], references: [id])
  WorkOrderAssignment WorkOrderAssignment[]
  WorkOrderLabor      WorkOrderLabor[]
  WorkOrderPart       WorkOrderPart[]
  PunchRecord         PunchRecord[]
}

model WorkOrderAssignment {
  id              String          @id @default(cuid())
  workOrderId     String
  employeeId      String
  assignedAt      DateTime        @default(now())
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
  WorkOrder       WorkOrder       @relation(fields: [workOrderId], references: [id])
}

model WorkOrderLabor {
  id              String          @id @default(cuid())
  workOrderId     String
  employeeId      String
  hours           Float
  rate            Float
  note            String?
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
  WorkOrder       WorkOrder       @relation(fields: [workOrderId], references: [id])
}

model WorkOrderPart {
  id          String    @id @default(cuid())
  workOrderId String
  partId      String
  quantity    Int
  unitPrice   Float
  markupPct   Float     @default(0.15)
  Part        Part      @relation(fields: [partId], references: [id])
  WorkOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  MECHANIC
  FRONT_DESK
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum WorkOrderStatus {
  DIAGNOSED
  APPROVED
  IN_PROGRESS
  COMPLETED
}
