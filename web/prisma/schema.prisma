generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id             String    @id @default(cuid())
  name           String
  contactName    String?
  phone          String?
  email          String?
  billingAddress String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  Invoice        Invoice[]
  Vehicle        Vehicle[]
}

model EmployeeProfile {
  id                  String                @id @default(cuid())
  name                String
  role                Role
  payRate             Float
  status              String                @default("active")
  userId              String                @unique
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  User                User                  @relation(fields: [userId], references: [id])
  TimeEntry           TimeEntry[]
  WorkOrderAssignment WorkOrderAssignment[]
  WorkOrderLabor      WorkOrderLabor[]
}

model Invoice {
  id                   String        @id @default(cuid())
  workOrderId          String        @unique
  customerId           String
  subtotalParts        Float
  subtotalLabor        Float
  tax                  Float
  discount             Float         @default(0)
  total                Float
  status               PaymentStatus @default(UNPAID)
  portalTokenHash      String?
  portalTokenExpiresAt DateTime?
  portalViewedAt       DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  Customer             Customer      @relation(fields: [customerId], references: [id])
  WorkOrder            WorkOrder     @relation(fields: [workOrderId], references: [id])
  Payment              Payment[]
}

model Part {
  id            String          @id @default(cuid())
  sku           String          @unique
  name          String
  category      String?
  cost          Float
  price         Float
  stock         Int             @default(0)
  reorderPoint  Int             @default(0)
  vendorId      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  Vendor        Vendor?         @relation(fields: [vendorId], references: [id])
  WorkOrderPart WorkOrderPart[]
}

model Payment {
  id                    String   @id @default(cuid())
  invoiceId             String
  method                String
  amount                Float
  receivedAt            DateTime @default(now())
  stripeChargeId        String?
  stripePaymentIntentId String?  @unique
  stripeStatus          String?
  Invoice               Invoice  @relation(fields: [invoiceId], references: [id])
}

model TimeEntry {
  id              String          @id @default(cuid())
  employeeId      String
  clockIn         DateTime
  clockOut        DateTime?
  jobId           String?
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  passwordHash    String
  role            Role
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  EmployeeProfile EmployeeProfile?
}

model Vehicle {
  id           String      @id @default(cuid())
  vin          String      @unique
  unitNumber   String?
  make         String
  model        String
  year         Int?
  mileage      Int?
  licensePlate String?
  customerId   String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  Customer     Customer    @relation(fields: [customerId], references: [id])
  WorkOrder    WorkOrder[]
}

model Vendor {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Part      Part[]
}

model WorkOrder {
  id                  String                @id @default(cuid())
  vehicleId           String
  status              WorkOrderStatus       @default(DIAGNOSED)
  description         String
  checklist           String?
  notes               String?
  laborHours          Float                 @default(0)
  partsTotal          Float                 @default(0)
  laborRate           Float                 @default(125)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  Invoice             Invoice?
  Vehicle             Vehicle               @relation(fields: [vehicleId], references: [id])
  WorkOrderAssignment WorkOrderAssignment[]
  WorkOrderLabor      WorkOrderLabor[]
  WorkOrderPart       WorkOrderPart[]
}

model WorkOrderAssignment {
  id              String          @id @default(cuid())
  workOrderId     String
  employeeId      String
  assignedAt      DateTime        @default(now())
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
  WorkOrder       WorkOrder       @relation(fields: [workOrderId], references: [id])
}

model WorkOrderLabor {
  id              String          @id @default(cuid())
  workOrderId     String
  employeeId      String
  hours           Float
  rate            Float
  note            String?
  EmployeeProfile EmployeeProfile @relation(fields: [employeeId], references: [id])
  WorkOrder       WorkOrder       @relation(fields: [workOrderId], references: [id])
}

model WorkOrderPart {
  id          String    @id @default(cuid())
  workOrderId String
  partId      String
  quantity    Int
  unitPrice   Float
  markupPct   Float     @default(0.15)
  Part        Part      @relation(fields: [partId], references: [id])
  WorkOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  MECHANIC
  FRONT_DESK
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum WorkOrderStatus {
  DIAGNOSED
  APPROVED
  IN_PROGRESS
  COMPLETED
}
